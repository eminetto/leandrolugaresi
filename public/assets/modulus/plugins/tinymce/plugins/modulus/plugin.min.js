/**
 * plugin.js
 *
 * Copyright, Leandro Lugaresi
 * Released under Creative Commons Attribution-NonCommercial 3.0 Unported License.
 */

tinymce.PluginManager.add('modulus', function(editor) {

	tinymce.activeEditor.settings.file_browser_callback = modulus;
	//Integração com imagens, videos e anexos defaults
	function modulus (id, value, type, win) {
		// DEFAULT AS FILE
		urltype='';
		typeFilter = '';
		if (type=='image') {
			urltype='/images';
		}
		if (type=='media') {
			urltype='/videos';
		}
        var title="FileManager";
        if (typeof editor.settings.filemanager_title !== "undefined" && editor.settings.filemanager_title)
            title=editor.settings.filemanager_title;

		tinymce.activeEditor.windowManager.open({
			title: title,
			file: '/modulus/filemanager'+urltype+'?entity=' +filemanager.entity+ '&entityId=' + filemanager.entityId,
			width: 860,
			height: 570,
			resizable: true,
			maximizable: true,
			inline: 1
			}, {
			setUrl: function (url) {
				var fieldElm = win.document.getElementById(id);
                //fieldElm.value = editor.convertURL(url);
				fieldElm.value = url;
				if ("fireEvent" in fieldElm) {
					fieldElm.fireEvent("onchange")
				} else {
					var evt = document.createEvent("HTMLEvents");
					evt.initEvent("change", false, true);
					fieldElm.dispatchEvent(evt);
				}
			}
		});
	};

	//Criação dos botões alternativos de adição de video e imagem

	function openmanagerimage() {
        var win, data;
        win = editor.windowManager.open({

            title: 'Image Manager',
            data: data,
            classes: 'filemanager',
            url: '/modulus/filemanager/images?track='+ editor.id+ '&functionName=1&entity=' +filemanager.entity+ '&entityId=' + filemanager.entityId,
            filetype: 'image',
            width: 900,
            height: 600,
            inline: 1
        })
    }

    function openmanagervideo() {
        var win, data;
        win = editor.windowManager.open({

            title: 'Video Manager',
            data: data,
            classes: 'filemanager',
            url: '/modulus/filemanager/videos?track='+ editor.id+ '&functionName=1&entity=' +filemanager.entity+ '&entityId=' + filemanager.entityId,
            filetype: 'video',
            width: 900,
            height: 600,
            inline: 1
        })
    }

    editor.addButton('addImage', {
        text: 'Adicionar Imagem',
        icon: "image",
        onclick: function() {
            // Open window
            editor.windowManager.open({
                title: 'adicionar imagens',
                body: [
                    {
                        type: 'container',
                        layout: 'flex',
                        classes: 'combobox has-open',
                        label: 'Source',
                        direction: 'row',
                        items: [{
                            name: 'src',
                            type: 'textbox',
                            filetype: 'image',
                            size: 35,
                            classes: 'img_' + editor.id,
                            autofocus: true
                        }, {
                            name: 'upl_img',
                            type: 'button',
                            classes: 'btn open',
                            icon: 'browse',
                            onclick: openmanagerimage,
                            tooltip: 'Upload image'
                        }]
                    }
                ],
                onsubmit: function(c) {
                    // Insert content when the window form is submitted
                    editor.insertContent('<p>'+c.data.src+'</p>');
                }
            });
        }
    });

    editor.addButton('addVideo', {
        text: 'Adicionar vídeo',
        icon: "media",
        onclick: function() {
            // Open window
            editor.windowManager.open({
                title: 'adicionar videos',
                body: [
                    {
                        type: 'container',
                        layout: 'flex',
                        classes: 'combobox has-open',
                        label: 'Source',
                        direction: 'row',
                        items: [{
                            name: 'src',
                            type: 'textbox',
                            filetype: 'image',
                            size: 35,
                            classes: 'vid_' + editor.id,
                            autofocus: true
                        }, {
                            name: 'upl_video',
                            type: 'button',
                            classes: 'btn open',
                            icon: 'browse',
                            onclick: openmanagervideo,
                            tooltip: 'Upload video'
                        }]
                    }
                ],
                onsubmit: function(r) {
                    // Insert content when the window form is submitted
                    editor.insertContent('<p>'+r.data.src+'<p>');
                }
            });
        }
    });
	return false;
});
